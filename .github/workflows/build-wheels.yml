# Kuat distribution - Python wheels + CLI binaries
#
# REQUIRED SECRET: QUATTREE_PAT - Fine-grained PAT with read access to Kuat-Inc/Quattree
#
# Creates GitHub Release with:
#   - Python wheels for all platforms (3.9-3.12)
#   - CLI binaries (quat-tree) for encoding datasets

name: Build & Release

on:
  push:
    branches: [main, master]
    tags: ['v*']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"

jobs:
  # ============================================================================
  # CLI Binaries (quat-tree for encoding)
  # ============================================================================
  cli-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Quattree
        run: git clone https://${{ secrets.QUATTREE_PAT }}@github.com/Kuat-Inc/Quattree.git .

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build CLI
        run: cargo build --release --features native

      - name: Package
        run: |
          mkdir -p release
          cp target/release/quat-tree release/quat-tree-linux-x64
          chmod +x release/quat-tree-linux-x64

      - uses: actions/upload-artifact@v4
        with:
          name: cli-linux-x64
          path: release/quat-tree-linux-x64

  cli-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            suffix: macos-arm64
          - target: x86_64-apple-darwin
            suffix: macos-x64
    steps:
      - name: Clone Quattree
        run: git clone https://${{ secrets.QUATTREE_PAT }}@github.com/Kuat-Inc/Quattree.git .

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Build CLI
        run: cargo build --release --features native --target ${{ matrix.target }}

      - name: Package
        run: |
          mkdir -p release
          cp target/${{ matrix.target }}/release/quat-tree release/quat-tree-${{ matrix.suffix }}
          chmod +x release/quat-tree-${{ matrix.suffix }}

      - uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.suffix }}
          path: release/quat-tree-${{ matrix.suffix }}

  cli-windows:
    runs-on: windows-latest
    steps:
      - name: Clone Quattree
        run: git clone https://${{ secrets.QUATTREE_PAT }}@github.com/Kuat-Inc/Quattree.git .

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build CLI
        run: cargo build --release --features native

      - name: Package
        run: |
          mkdir release
          copy target\release\quat-tree.exe release\quat-tree-windows-x64.exe

      - uses: actions/upload-artifact@v4
        with:
          name: cli-windows-x64
          path: release/quat-tree-windows-x64.exe

  # ============================================================================
  # Python Wheels - Linux (manylinux via Docker)
  # ============================================================================
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python${{ matrix.python-version }}
          manylinux: auto
          # Clone Quattree INSIDE the Docker container before building
          before-script-linux: |
            git clone https://${{ secrets.QUATTREE_PAT }}@github.com/Kuat-Inc/Quattree.git ../Quattree
            ls -la ../Quattree

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}-py${{ matrix.python-version }}
          path: dist/*.whl

  # ============================================================================
  # macOS (ARM64 native + x86_64 cross-compile)
  # ============================================================================
  macos:
    runs-on: macos-latest  # ARM64 (M1/M2)
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
    steps:
      - uses: actions/checkout@v4

      - name: Clone Quattree
        run: git clone https://${{ secrets.QUATTREE_PAT }}@github.com/Kuat-Inc/Quattree.git ../Quattree

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i python${{ matrix.python-version }}

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.target }}-py${{ matrix.python-version }}
          path: dist/*.whl

  # ============================================================================
  # Windows (x64)
  # ============================================================================
  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Clone Quattree
        run: git clone https://${{ secrets.QUATTREE_PAT }}@github.com/Kuat-Inc/Quattree.git ../Quattree

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64-pc-windows-msvc
          args: --release --out dist -i python${{ matrix.python-version }}

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-x64-py${{ matrix.python-version }}
          path: dist/*.whl

  # ============================================================================
  # Combine all artifacts + Release (runs even if some jobs fail)
  # ============================================================================
  release:
    runs-on: ubuntu-latest
    needs: [cli-linux, cli-macos, cli-windows, linux, macos, windows]
    if: always() && startsWith(github.ref, 'refs/tags/')  # Always run on tags
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: wheels-*
          path: dist/wheels
          merge-multiple: true

      - name: Download CLI artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: cli-*
          path: dist/cli
          merge-multiple: true

      - name: List what we got
        run: |
          echo "=== Python Wheels ==="
          ls -la dist/wheels/ 2>/dev/null || echo "No wheels found"
          echo ""
          echo "=== CLI Binaries ==="
          ls -la dist/cli/ 2>/dev/null || echo "No CLI binaries found"
          echo ""
          echo "=== Total artifacts ==="
          find dist -type f 2>/dev/null | wc -l || echo "0"

      - name: Check we have at least something
        run: |
          WHEEL_COUNT=$(find dist/wheels -name "*.whl" 2>/dev/null | wc -l || echo 0)
          CLI_COUNT=$(find dist/cli -type f 2>/dev/null | wc -l || echo 0)
          TOTAL=$((WHEEL_COUNT + CLI_COUNT))
          echo "Found $WHEEL_COUNT wheels and $CLI_COUNT CLI binaries"
          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No artifacts to release!"
            exit 1
          fi
          echo "Proceeding with release..."

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/wheels/*.whl
            dist/cli/*
          fail_on_unmatched_files: false  # Don't fail if some patterns don't match
          generate_release_notes: true
          body: |
            ## Installation
            
            ### 1. Download CLI binary for your OS (for encoding datasets)
            - **Windows**: `quat-tree-windows-x64.exe`
            - **macOS ARM (M1/M2)**: `quat-tree-macos-arm64`
            - **macOS Intel**: `quat-tree-macos-x64`
            - **Linux**: `quat-tree-linux-x64`
            
            ### 2. Install Python wheel for your platform
            ```bash
            pip install kuat-*-cp3XX-*-YOUR_PLATFORM.whl
            ```
            
            ### 3. Encode your dataset
            ```bash
            quat-tree vq-create /path/to/images -o dataset.kt -r
            ```
            
            ### 4. Use in training
            ```python
            from kuat import GPUDataset
            dataset = GPUDataset("dataset.kt", device="cuda")
            ```
            
            ---
            *Note: Some platform/Python combinations may be missing if builds failed. Check the Actions tab for details.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
